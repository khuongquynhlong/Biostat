---
title: "Master in Statistics and Data Science"
author: 'Student: Quynh Long Khuong'
date: "Hasselt, Belgium, `r Sys.Date()`"
output:
  html_document:
    css: style.css
    highlight: pygments
    code_folding: hide
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 2
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '2'
subtitle: 'Linear Models: Homework 1'
institute: Hasselt University
always_allow_html: true
---


```{r, echo=FALSE}
htmltools::img(src = "https://www.uhasselt.be/images/logos/2019/UHasselt-standaard.png", 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; height:140px; width:auto; max-width:300px;')
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'), color = 'red', tooltip_message = 'Click to copy', tooltip_success = 'Copied! :D')
```

<div style= "height:60px; width:auto; max-width:100px;">
[![My github](images/github2.png)](https://khuongquynhlong.github.io/Biostat/)
</div>


```{r}
library(tidyverse)
library(magrittr)
library(plotly)
library(DT)
library(viridis)
```

# Question 1 {.tabset .tabset-fade .tabset-pills}

Immunoglobulins in the blood are known to protect against diseases. We consider a preclinical study in which a potential new drug, a chemical compound with the name ADDF19, is evaluated for negative side effects. One of these effects, could be its negative effect on the blood serum levels of Immunoglobulin IgG1. Healthy mice have IgG1 blood serum concentrations between 1.2 and 5 *mg/l*.

A lab animal experiment is set up with 18 mice. For each of the following doses of ADDF19, three mice were included in the study: 0.5*µg*, 0.75*µg*, 1*µg*, 1.25*µg*, 1.5*µg* and 2*µg*. The data are given in the R data file `mice.RData`.

You are asked to perform statistical analysis for answering the following research questions:


:::: {.blackbox data-latex=""}
::: {.infobox .question data-latex="{question}"}
**QUESTIONS**


1. What is the effect of the concentration of `ADDF19` on the mean `IgG1` blood level concentrations?

2. Give an appreciation of the (im)precision of the previous estimate (standard error and a 95% confidence interval).

3. Is there a significant effect of the concentration of `ADDF19` on the mean `IgG1` blood level concentrations? This test must be performed at the 5% level of significance.

:::
::::

<br>


**ANSWERS**


## Data exproration


```{r}
load("data/mice.RData")
mice %>% datatable(caption = "Table 1: Mice dataset.")
```

<br>

```{r, fig.fullwidth = TRUE, fig.height = 6, fig.width = 9}
# Create theme for ggplot
mytheme <- function(...) {
    theme(
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(size = 0.3),
    axis.text = element_text(size = 14, color = "black", hjust=1),
    axis.title = element_text(face = "bold", size = 14, color = "black"),
    plot.title = element_text(face = "bold", size = 16, color = "black"),
    plot.subtitle = element_text(face = "italic", size = 12, color = "black")
  )
}

# Create plot mean function to display mean of y value on the figure
plot.mean = function(x){
    m = mean(x)
    c(y = m, ymin = m, ymax = m)
}

# Dot plot + mean value of IgG1 per concentration
mice %>% 
  mutate(concentration = as.factor(concentration)) %>%
  ggplot(aes(x = concentration, y = IgG1, fill = concentration)) + 
  geom_dotplot(binaxis ='y', stackdir ='center', dotsize = 1.5, alpha = 0.8,
               show.legend = F, color = "#e31a1c") +
  stat_summary(fun.data = "plot.mean", geom = "errorbar", colour = "#3690c0", size = 1) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "ADDF19 dose (µg)",
       y = "IgG1 (mg/l)",
       title = "Figure 1: Blood serum levels of IgG1 per concentration",
       subtitle = "The dots represent values of IgG1 and blue lines are mean of IgG1 per concentration") +
    theme_bw() +
    mytheme()
```



<br>

<br>

## Q1.1

<span style="color: #3690c0;">***Effect of the concentration of `ADDF19` on the mean `IgG1` blood level concentrations***</span>

<br>

The relationship between `IgG1` blood level concentrations and doses of `ADDF19` is given by

$$IgG1_i = m(ADDF19_i; \boldsymbol{\beta}) + \varepsilon _i$$

In this case, we examine the linear relationship between the two variables, so the function $m(ADDF19_i; \boldsymbol{\beta})$ is restricted to the linear function of $\boldsymbol{\beta}$, which is

$$m(ADDF19; \boldsymbol{\beta}) = \beta_0 + \beta_1ADDF19$$
Which leads to

$$IgG1_i = \beta_0 + \beta_1ADDF19_i + \varepsilon _i$$

<br>


```{r}
m1 <- lm(IgG1 ~ concentration, data = mice)
summary(m1)
```

Linear model of `IgG1` and `ADDF19` is


$$IgG1_i = 2.9627 - 0.49*ADDF19_i + \varepsilon _i$$

<span style="color: #3690c0;">***Conclusion:***</span> The blood level concentration of IgG1 decreases by 0.49 mg/l on average when the dose of ADDF19 increases by 1 µg.


<br>




<br>

## Q1.2

<span style="color: #3690c0;">***The (im)precision of the previous estimate (standard error and a 95% confidence interval)***</span>

<br>

The standard errors of the parameter estimates are:

$$\hat{\sigma}_{\beta_0} = 0.2116 \textrm{ and } \hat{\sigma}_{\beta_1} = 0.1671$$

The 95% confidence interval of $\beta_1$:

```{r}
# lower bound of 95% CI
lb <- -0.49 - qt(0.975, df = 16)*0.1671

# Upper bound of 95% CI
ub <- -0.49 + qt(0.975, df = 16)*0.1671

sprintf("lower bound: %.3f; upper bound: %.3f", lb, ub)
```

The confidence interval of $\beta_1$ thus becomes [`r round(lb, 3)`, `r round(ub, 3)`]



<br>

## Q1.3

<span style="color: #3690c0;">***Is there a significant effect of the concentration of `ADDF19` on the mean `IgG1` blood level concentrations? This test must be performed at the 5% level of significance***</span>

<br>

***Hypothesis Testing***

The null hypothesis is that there is no effect of `ADDF19` on the mean `IgG1` blood level concentrations. 

$$H_0: \beta_1 = 0$$

Since we want to evaluate the **negative side effect** of `ADDF19` on the `IgG1` blood level concentrations, the one-sided alternative hypothesis is applied. Thus, the alternative hypothesis becomes

$$H_1: \beta_1 < 0$$

Calculating the one-sided p-value, which is the probability of observing the data or more extreme cases (toward $H_1$) given the null hypothesis is true

$$p = P_0 \left\{T\leq t\right\} = F_T(t; n - 2)$$

Where $F_T(t; n - 2)$ is the CDF of $t_{n-2}$


```{r}
# Calculating test statistics
t_stat <- -0.49/0.1671

# Two-sided p-value
pvalue <-  pt(t_stat, df = 16)

paste0("One-sided p-value = ", pvalue)
```


<span style="color: #3690c0;">***Conclusion:***</span> Since the p-value is less than the significant level (at 5%), we reject H~0~ and conclude that `ADDF19` has the negative effect on the mean `IgG1` blood level concentrations.

<br>


## Summary


:::: {.blackbox data-latex=""}
::: {.summarybox .summary data-latex="{summary}"}

**Summary**

The new drug ADDF19 has a negative effect on the blood serum levels of immunoglobulin IgG1. Specifically, the IgG1 blood serum level decreases by 0.49 mg/l on average when dose of ADDF19 increases by 1 µg (95% CI: -0.84 to -0.14; statistically significant at one-sided p-value = 0.0049).


:::
::::


<br>

<br>

# Question 2 {.tabset .tabset-fade .tabset-pills}

A simulation study in the context of the previous question. Use simulations to construct a graph with on the vertical axis the minimal required sample size _n_ for obtaining a power of 80%, and on the horizontal axis the effect size $\beta_1$. The significance level may be fixed at 5%

You will need to fix the residual variance $\sigma^2$. You may use the results of your data analysis to come up with reasonable values for $\sigma^2$

You will also need to fix the regressor values. You may take the same 18 regressor values as for question 1.

You will also need to choose between two-sided or one-sided alternative hypothesis. Choose the same type of alternative hypothesis as what you have chosen for question 1.

For your information, the power of the statistical test is defined as follows:


:::: {.blackbox data-latex=""}
::: {.infobox2 .info data-latex="{info}"}
**INFORMATION**

* For $H_1: \beta_1 > 0$:


$$power = P \left\{T > t_{n-2;1-\alpha}|\beta_1^∗\right\} $$

  Thus this probability requires the distribution of the test statistic T under the specific alternative hypotheses $H_1 : \beta = \beta_1^∗$ for some fixed $\beta_1^* > 0$.


* For $H_1: \beta_1 < 0$:


$$power = P \left\{T < -t_{n-2;1-\alpha}|\beta_1^∗\right\}$$

  Thus this probability requires the distribution of the test statistic T under the specific alternative hypotheses $H_1 : \beta = \beta_1^∗$ for some fixed $\beta_1^* < 0$.


* For $H_1: \beta_1 \neq 0$:

$$power = P \left\{|T| > t_{n-2;1-\alpha/2}|\beta_1^∗\right\} $$

  Thus this probability requires the distribution of the test statistic T under the specific alternative hypotheses $H_1 : \beta = \beta_1^∗$ for some fixed $\beta_1^* \neq 0$.


:::
::::

<br>


**ANSWER**

<br>

:::: {.blackbox data-latex=""}
::: {.infobox2 .summary data-latex="{summary}"}

**Input (fixed) parameters**

* Residual variance: $\sigma^2$ obtained from previous model: `sum((m1$residuals)^2)/m1$df.residual` = 0.122135.

* The regressor values (18 values) to construct design matrix $\boldsymbol{X}$.

* As explained in Question 1, the one-sided alternative hypothesis is chosen.

:::
::::

Hypothesis: 

$$H_0: \beta_1 = 0 \textrm{ versus } H_1: \beta_1 < 0$$ 

The test statistics and null distribution are

$$T = \frac{\hat{\beta_1}}{\sigma_{\beta_1}} \stackrel{H_0}{\sim} t_{n-p}$$

Rewrite it as

$$T = \frac{\hat{\beta_1}}{\sigma_{\beta_1}} = \frac{\hat{\beta_1} - \delta + \delta}{\sigma_{\beta_1}} = \frac{\hat{\beta_1} - \delta}{\sigma_{\beta_1}} + \frac{\delta}{\sigma_{\beta_1}}$$

Under hypothesis $H_1(\delta): \beta_1 = \delta$

$$\frac{\hat{\beta_1} - \delta}{\sigma_{\beta_1}} \stackrel{H_1}{\sim} t_{n-p}$$

Thus

$$T = \frac{\hat{\beta_1} - \delta}{\sigma_{\beta_1}} + \frac{\delta}{\sigma_{\beta_1}} \stackrel{H_1}{\sim} t_{n-p, \nu}$$

With n - p degrees of freedom and noncentrality parameter (ncp) $\nu$

Thus, in the one-sided alternative hypotheses, the power is given by

$$power = P \left\{T < t_{n-p;1-\alpha}|\beta_1 = \delta\right\} = F_t(-t_{n-p;1-\alpha}; n-p, \nu)$$
For fixed $\delta < 0$

$F_t(.; n-p, \nu)$ is the CDF of a noncentral t-distribution with degrees of freedom $n-p$ and ncp $\nu$

<br>

:::: {.blackbox data-latex=""}
::: {.summarybox .note data-latex="{note}"}

**Noted**

* $\sigma_{\beta_1}^2 = [(\boldsymbol{X}^t\boldsymbol{X})^{-1}]_{2,2}\sigma^2$

:::
::::

<br>

<br>


***Doing simulation in R***

<span style="color: #e73b2b;">**My approach: the power will be first calculated according to each sample size and effect size. Power values then will be fixed at approximately 0.8 to generate the graph of relationship between sample size and effect size**:</span> 

<span style="color: #3690c0;">Function to create design matrix X:</span> 

*`n` = total sample size, must be a multiple of 18 (use the information from 18 values of regressor in the Question 1)*


```{r}
design_MatX <- function(n) {
    m <- n / 18
    X <- matrix(nrow = n, ncol = 2)
    X[, 1] <- 1
    X[, 2] <- rep(mice[, 1], rep(m, 18))
    return(X)
}
```

<span style="color: #3690c0;">Function to calculate power:</span> 

*`n` = total sample size, must be a multiple of 18*

*`delta`: effect size*

*`sigma2`: residual variance, set default as residual variance of model in question 1*

*`alpha`: Type I error rate, set at 5%*

```{r}
powerX <- function(n, delta, sigma2 = 0.122135, alpha = 0.05) {
    X <- design_MatX(n)
    # Calculate standard error for beta1 coefficient
    se_Beta1 <- sqrt(solve(t(X)%*%X)[2, 2]*sigma2)
    # Calculate noncentrality parameter
    ncp <- delta/se_Beta1
    # Critical value at 1-alpha quantile and n-p degree of freedom
    tcrit <- qt(1-alpha, df = n - 3)
    # Calculate power
    pwr <- pt(-tcrit, df = n - 3, ncp = ncp)
    return(pwr)
}
```

<br>

Check the function with delta = 0, the power should be equal alpha

```{r}
# Check
powerX(n = 180, delta = 0) # must equal alpha
```

<br>


<span style="color: #3690c0;">Generate dataset and the graph (*show data if powers approximate 0.8*):</span> 

```{r}
seqnum_es <-seq(-1, 0, by = 0.005)
seqnum_n <- 18*seq(1:10)

# The expand.grid() function can also be used here
df_pwr <- data.frame(sample_size = rep(seqnum_n, length(seqnum_es)),
                     effect_size = rep(seqnum_es, length(seqnum_n)),
                     power = NA) %>% arrange(sample_size, effect_size)

for (i in 1:nrow(df_pwr)) {
    df_pwr[i, 3] <- powerX(n = df_pwr[i, 1], delta = df_pwr[i, 2])
}

# Show data if powers approximate 0.8
df_pwr %>% 
  filter(power >= 0.8 & power <0.81) %>% 
  datatable(caption = "Table 2: Dataframe of sample size and effect size given powers are fixed at ~0.8")

```

<br>

<span style="color: #3690c0;">3D graph for relationship between power, sample size, and effect size:</span> 


```{r, fig.fullwidth = TRUE, fig.height = 8, fig.width = 9}
# set up color
mycolor <- c("#014636", "#016c59", "#02818a", "#3690c0", "#67a9cf",
             "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#980043")

df_pwr %>%
  plot_ly(x = ~effect_size, y = ~sample_size, 
          z = ~power, color = ~as.factor(sample_size), 
          colors = mycolor,
          text = paste0("<b>Effect size:</b> ", df_pwr$effect_size, "<br>",
                        "<b>Sample size:</b> ", df_pwr$sample_size, "<br>",
                        "<b>Power:</b> ", round(df_pwr$power, 2), "<br>"),
          hoverinfo = "text") %>%
      add_markers() %>% 
      layout(title = "Figure 2: Relationship between power, sample size, and effect size",
             scene = list(
                 xaxis = list(title = "Effect size"),
                 yaxis = list(title = "Sample size"),
                 zaxis = list(title = "Power")),
             showlegend = FALSE)
```

<br>

<span style="color: #3690c0;">2D graph for relationship between sample size and effect size, fixing power at approximately 0.8:</span> 


```{r, fig.fullwidth = TRUE, fig.height = 6, fig.width = 9}
df_pwr_fix <- df_pwr %>% filter(power >= 0.8 & power <0.81)
df_pwr_fix %>% 
  plot_ly(x = ~effect_size, y = ~sample_size, 
          text = paste0("<b>Sample size:</b> ", df_pwr_fix$sample_size, "<br>",
                        "<b>Effect size:</b> ", df_pwr_fix$effect_size, "<br>",
                        "<b>Power:</b> ", "~0.8", "<br>"),
          hoverinfo = "text",
          marker = list(size = 15, color = "#fd8d3c",
                        line = list(color = "#e31a1c", width = 2))) %>%
  add_lines(line = list(shape = "spline"), size = I(3)) %>%
  add_markers() %>% 
  layout(title = "Figure 3: Relationship between sample size and effect size, at power ~ 0.8",
         xaxis = list(title = "Effect size"),
         yaxis = list(title = "Sample size"),
         showlegend = FALSE)
```

<br>

<span style="color: #3690c0;">***Conclusion:***</span> As the effect size decreases ($|\beta_1|$ moves toward zero), the sample size needed to achieve a power of 0.8 becomes larger.










